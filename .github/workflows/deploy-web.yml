name: CI → Web Export & itch.io

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  deploy_web:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout + Git LFS
      - name: Checkout game (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Pull Git LFS content
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git lfs pull

      # 2) Sanity-check web/ folder
      - name: Ensure web/ exists and is non-empty
        run: |
          if [ ! -d web ]; then
            echo "❌ web/ directory is missing. Did you forget to commit your build?"
            exit 1
          fi
          if [ -z "$(ls -A web)" ]; then
            echo "❌ web/ is empty. Make sure your build output is in web/."
            exit 1
          fi

      # 3) Check for index.html
      - name: Verify web/index.html
        run: |
          if [ ! -f web/index.html ]; then
            echo "❌ web/index.html not found. Expected the HTML5 entrypoint there."
            exit 1
          fi
          if [ ! -s web/index.html ]; then
            echo "❌ web/index.html exists but is empty."
            exit 1
          fi

      # 4) Publish to itch.io (only on main)
      - name: Publish to itch.io
        if: ${{ github.ref == 'refs/heads/main' }}
        env:
          BUTLER_API_KEY: ${{ secrets.ITCHIO_API_KEY }}
        run: |
          curl -L https://broth.itch.ovh/butler/linux-amd64/latest/archive/default \
            -o butler
          chmod +x butler
          ./butler push web "${{ secrets.ITCHIO_GAME }}:html5"
