name: CI → Web Export & itch.io

on:
  push:
    branches: [main]
  pull_request:

jobs:
  deploy_web:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (incl. LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Pull Git LFS content
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git lfs pull

      - name: Install system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            xz-utils wget curl gnupg software-properties-common \
            libgl1 libglx-mesa0 libglu1-mesa \
            libxi6 libxrandr2 libxinerama1 libxcursor1 libxrender1

      - name: Add Rob Savoury’s PPA and install Blender ≥ 4.5
        run: |
          curl -fsSL "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x374C7797FB006459" \
            | gpg --dearmor > /usr/share/keyrings/robsavoury.gpg
          echo "deb [signed-by=/usr/share/keyrings/robsavoury.gpg] http://ppa.launchpadcontent.net/savoury1/blender/ubuntu $(lsb_release -cs) main" \
            > /etc/apt/sources.list.d/savoury1-blender.list
          apt-get update
          apt-get install -y blender
          blender --version

      - name: Download Godot 4.4.1‑stable tar.xz
        run: |
          GODOT_VER="4.4.1-stable"
          URL="https://github.com/godotengine/godot/releases/download/${GODOT_VER}/godot-${GODOT_VER}.tar.xz"
          echo "Downloading Godot from: $URL"
          wget --tries=3 --timeout=60 -O godot.tar.xz "$URL"

      - name: Extract Godot binary reliably
        run: |
          F=$(tar -tf godot.tar.xz \
               | grep -E '[Ll]inux.*x86_64$' \
               | head -n1)
          echo "Found binary in archive: $F"
          sudo tar -xJf godot.tar.xz -C /usr/local/bin "$F"
          sudo ln -sf "/usr/local/bin/$F" /usr/local/bin/godot
          sudo chmod +x "/usr/local/bin/godot"
          godot --version

      - name: Prepare export directories
        run: mkdir -p .godot web

      - name: Import assets (Godot → Web)
        run: >
          godot --headless --editor --quit --import
            --set-setting editor/import/blender/blender_path="$(which blender)"

      - name: Export HTML5 Web Build
        run: >
          godot --headless --export-release "HTML5" web/index.html

      - name: Publish to itch.io (on main only)
        if: ${{ github.ref == 'refs/heads/main' }}
        env:
          BUTLER_API_KEY: ${{ secrets.ITCHIO_API_KEY }}
        run: |
          curl -fsSL https://broth.itch.ovh/butler/linux-amd64/latest/archive/default -o butler
          chmod +x butler
          ./butler push web "${{ secrets.ITCHIO_GAME }}:html5"
