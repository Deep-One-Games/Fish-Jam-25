name: CI â†’ Web Export & itch.io

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  deploy_web:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout + Git LFS
      - name: Checkout game (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Pull Git LFS content
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git lfs pull

      # 2) Install necessary system libs
      - name: Install system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            xz-utils wget unzip \
            libgl1 libglx-mesa0 libglu1-mesa \
            libxi6 libxrender1 libxrandr2 \
            libxinerama1 libxcursor1

      # 3) Download & install Blender 4.5.1
      - name: Install Blender 4.5.1
        run: |
          mkdir -p /opt/blender
          wget --tries=3 --timeout=60 \
            https://download.blender.org/release/Blender4.5/blender-4.5.1-linux-x64.tar.xz \
            -O blender.tar.xz
          sudo tar -xJf blender.tar.xz -C /opt/blender --strip-components=1
          sudo ln -sf /opt/blender/blender /usr/local/bin/blender
          blender --version

      # 4) Install Godot 4.4.1 via tar.xz (stable release)
      - name: Install Godot 4.4.1
        run: |
          GODOT_VER=4.4.1
          INSTALL_DIR=/opt/godot/${GODOT_VER}
          sudo mkdir -p "${INSTALL_DIR}"
          wget --tries=3 --timeout=60 \
            "https://github.com/godotengine/godot/releases/download/${GODOT_VER}-stable/godot-${GODOT_VER}-stable.tar.xz" \
            -O godot.tar.xz
          sudo tar -xJf godot.tar.xz -C "${INSTALL_DIR}" --strip-components=1
          ls -l "${INSTALL_DIR}"
          sudo ln -sf "${INSTALL_DIR}/Godot_v${GODOT_VER}_linux.x86_64" /usr/local/bin/godot
          sudo chmod +x /usr/local/bin/godot
          godot --version

      # 5) Prepare directories for Godot export
      - name: Prepare directories
        run: mkdir -p .godot web

      # 6) Run asset import via Godot CLI
      - name: Import Godot assets
        run: |
          godot --headless --editor --quit --import \
            --set-setting editor/import/blender/blender_path="$(which blender)"

      # 7) Export HTML5 build
      - name: Export HTML5 build
        run: godot --headless --export-release "HTML5" web/index.html

      # 8) Deploy to itch.io (only on main branch)
      - name: Publish to itch.io
        if: ${{ github.ref == 'refs/heads/main' }}
        env:
          BUTLER_API_KEY: ${{ secrets.ITCHIO_API_KEY }}
        run: |
          curl -L https://broth.itch.ovh/butler/linux-amd64/latest/archive/default \
            -o butler
          chmod +x butler
          ./butler push web "${{ secrets.ITCHIO_GAME }}:html5"
