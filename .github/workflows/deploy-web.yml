name: CI â†’ Web Export & itch.io

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  deploy_web:
    runs-on: ubuntu-latest
    container: barichello/godot-ci:latest

    steps:
      - name: Checkout game (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Pull LFS files
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git lfs pull

      - name: Install Blender LTS
        run: |
          # Download a recent Blender 4.2 LTS build. This link is more stable.
          # NOTE: I've updated this to a plausible working link for a 4.2.x release.
          wget https://download.blender.org/release/Blender4.2/blender-4.2.2-linux-x64.tar.xz
          
          # Extract the archive using a wildcard to match the exact filename
          tar -xf blender-*-linux-x64.tar.xz
          
          # Find the name of the extracted directory dynamically and store it in a variable
          BLENDER_DIR=$(find . -maxdepth 1 -type d -name 'blender-*')
          
          # Add the path to the blender executable to the environment for subsequent steps
          echo "BLENDER_PATH=$GITHUB_WORKSPACE/$BLENDER_DIR/blender" >> $GITHUB_ENV

          # Verify the installation and path
          echo "Blender was found in: $BLENDER_DIR"
          echo "Executable path is: ${{ env.BLENDER_PATH }}"
          ${{ env.BLENDER_PATH }} --version
        id: setup_blender

      - name: Create Godot and Export Directories
        run: mkdir -p .godot web

      - name: Import Assets with Correct Blender Path
        run: |
          timeout 300s godot --headless --editor --quit --import \
            --set-setting filesystem/import/blender/blender_path3 "${{ env.BLENDER_PATH }}"

      - name: Export HTML5 Web Build
        run: |
          godot --headless --export-release "HTML5" web/index.html

      - name: Publish to itch.io
        if: github.ref == 'refs/heads/main'
        env:
          BUTLER_API_KEY: ${{ secrets.ITCHIO_API_KEY }}
        run: |
          butler push web ${{ secrets.ITCHIO_GAME }}:html5
