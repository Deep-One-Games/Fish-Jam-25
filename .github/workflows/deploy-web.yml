name: CI → Web Export & itch.io

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  deploy_web:
    runs-on: ubuntu-latest
    container: barichello/godot‑ci:latest

    steps:
      - name: Checkout game (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Pull Git LFS content
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git lfs pull

      - name: Install system tools and OpenGL deps
        run: |
          apt-get update
          apt-get install -y \
            software-properties-common gnupg curl \
            libgl1-mesa-glx libglu1-mesa \
            libxi6 libxrender1 libxrandr2 libxinerama1 libxcursor1

      - name: Add Rob Savoury’s Blender PPA
        run: |
          curl -fsSL https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x374C7797FB006459 \
            | gpg --dearmor > /usr/share/keyrings/robsavoury.gpg
          echo "deb [signed-by=/usr/share/keyrings/robsavoury.gpg] \
            https://ppa.launchpadcontent.net/savoury1/blender/ubuntu $(lsb_release -cs) main" \
              > /etc/apt/sources.list.d/savoury1-blender.list
          echo "deb [signed-by=/usr/share/keyrings/robsavoury.gpg] \
            https://ppa.launchpadcontent.net/savoury1/ffmpeg4/ubuntu $(lsb_release -cs) main" \
              > /etc/apt/sources.list.d/savoury1-ffmpeg4.list
          apt-get update

      - name: Install Blender ≥ 4.5 from PPA
        run: apt-get install -y blender

      - name: Check Blender
        run: blender --version

      - name: Prepare export dirs
        run: mkdir -p .godot web

      - name: Import assets (Godot → Web)
        run: |
          godot --headless --editor --quit --import \
            --set-setting editor/import/blender/blender_path="$(command -v blender)"

      - name: Export HTML5 build
        run: godot --headless --export-release "HTML5" web/index.html

      - name: Publish to itch.io
        if: ${{ github.ref == 'refs/heads/main' }}
        env:
          BUTLER_API_KEY: ${{ secrets.ITCHIO_API_KEY }}
        run: butler push web ${{ secrets.ITCHIO_GAME }}:html5
