name: CI → Web Export & itch.io

on:
  # run on any commit to main
  push:
    branches: [ main ]
  # run on PRs targeting main
  pull_request:
    branches: [ main ]

jobs:
  deploy_web:
    runs-on: ubuntu-latest
    name: CI → Web Export & itch.io

    steps:
      # 1) Checkout + Git LFS
      - name: Checkout game (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Pull Git LFS content
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git lfs pull

      # 2) Ensure the PR actually changed web/
      - name: Require changes under web/
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          echo "Checking for any changes inside web/..."
          # fetch the base branch to compare
          git fetch origin ${{ github.base_ref }}
          # diff only web/; if empty, fail
          if [ -z "$(git diff --name-only origin/${{ github.base_ref }} -- web)" ]; then
            echo "No changes detected in web/. Please rebuild your game and include web/ artifacts."
            exit 1
          fi

      # 3) Sanity-check web/ folder
      - name: Ensure web/ exists and is non-empty
        run: |
          if [ ! -d web ]; then
            echo "web/ directory is missing. Did you forget to commit your build?"
            exit 1
          fi
          if [ -z "$(ls -A web)" ]; then
            echo "web/ is empty. Make sure your build output is in web/."
            exit 1
          fi
      
      # 4) Check for index.html
      - name: Setup butler (stable)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: |
          echo "Downloading butler stable .zip from broth"
          curl -L -o butler.zip https://broth.itch.ovh/butler/linux-amd64/LATEST/archive/default
          unzip butler.zip
          chmod +x butler
          ./butler -V
          
      # 5) Publish to itch.io (only on push to main)
      - name: Publish to itch.io
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        env:
          BUTLER_API_KEY: ${{ secrets.ITCHIO_API_KEY }}
        run: |
          ./butler push web "${{ secrets.ITCHIO_GAME }}:html5"
