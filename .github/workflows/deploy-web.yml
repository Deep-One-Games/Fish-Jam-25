name: CI → Web Export & itch.io

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy_web:
    runs-on: ubuntu-latest
    name: CI → Web Export & itch.io

    steps:
      # 1) Checkout + Git LFS
      - name: Checkout game (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Pull Git LFS content
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git lfs pull

      # 2) Require changes under web/ on PRs
      - name: Require changes under web/
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          echo "Checking for any changes inside web/..."
          git fetch origin ${{ github.base_ref }}
          if [ -z "$(git diff --name-only origin/${{ github.base_ref }} -- web)" ]; then
            echo "No changes in web/, please rebuild."
            exit 1
          fi

      # 3) Sanity-check web/ folder
      - name: Ensure web/ exists and non-empty
        run: |
          if [ ! -d web ]; then
            echo "Missing web/ directory"
            exit 1
          fi
          if [ -z "$(ls -A web)" ]; then
            echo "web/ folder is empty"
            exit 1
          fi

      # 4) Verify index.html
      - name: Verify web/index.html
        run: |
          if [ ! -f web/index.html ] || [ ! -s web/index.html ]; then
            echo "web/index.html missing or empty"
            exit 1
          fi

      # 5) Setup butler (stable)
      - name: Setup butler
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: |
          echo "Downloading butler"
          curl -L -o butler.zip https://broth.itch.ovh/butler/linux-amd64/LATEST/archive/default
          unzip butler.zip
          chmod +x butler
          echo "Butler version:"
          ./butler -V

      # 6) Zip up HTML5 build
      - name: Zip up HTML5 build
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: |
          cd web
          zip -r ../game.zip ./*
          cd ..

      # 7) Publish to itch.io (build target into a variable)
      - name: Publish to itch.io
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        env:
          BUTLER_API_KEY: ${{ secrets.ITCHIO_API_KEY }}
        run: |
          # Debug the raw secret (wrapped in delimiters so you see whitespace)
          echo "Raw ITCHIO_GAME secret = >${{ secrets.ITCHIO_GAME }}<"
          
          # Build the target string, no extra quotes around it
          TARGET="${{ secrets.ITCHIO_GAME }}:html5"
          echo "Uploading game.zip to target = $TARGET"
          
          # Push with the unquoted variable
          ./butler push game.zip $TARGET
