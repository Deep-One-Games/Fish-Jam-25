name: CI â†’ Web Export & itch.io

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  deploy_web:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout + Git LFS
      - name: Checkout game (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Pull Git LFS content
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git lfs pull

      # 2) Install core dependencies
      - name: Install system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            xz-utils wget unzip curl jq \
            libgl1 libglx-mesa0 libglu1-mesa \
            libxi6 libxrender1 libxrandr2 \
            libxinerama1 libxcursor1

      # 3) Install latest Blender
      - name: Install latest Blender
        run: |
          # Fetch latest version folder from Blender release index
          BLENDER_VER=$(curl -s https://download.blender.org/release/ \
            | grep -Po 'blender-[0-9]+\.[0-9]+\.[0-9]+/' \
            | sed 's|blender-||; s|/||' \
            | sort -V \
            | tail -1)
          INSTALL_DIR=/opt/blender/$BLENDER_VER
          mkdir -p $INSTALL_DIR
          wget -q \
            https://download.blender.org/release/Blender${BLENDER_VER%.*}/blender-$BLENDER_VER-linux-x64.tar.xz \
            -O blender.tar.xz
          sudo tar -xJf blender.tar.xz -C $INSTALL_DIR --strip-components=1
          sudo ln -sf $INSTALL_DIR/blender /usr/local/bin/blender
          blender --version

      # 4) Install latest Godot
      - name: Install latest Godot
        run: |
          GODOT_TAG=$(curl -s https://api.github.com/repos/godotengine/godot/releases/latest \
            | jq -r .tag_name)
          GODOT_VER=${GODOT_TAG#v}
          INSTALL_DIR=/opt/godot/$GODOT_VER
          ZIP_NAME=Godot_v${GODOT_VER}-stable_linux.x86_64.zip
          DOWNLOAD_URL="https://github.com/godotengine/godot/releases/download/${GODOT_TAG}/${ZIP_NAME}"
          sudo mkdir -p $INSTALL_DIR
          wget -q $DOWNLOAD_URL -O godot.zip
          sudo unzip -q godot.zip -d $INSTALL_DIR
          sudo ln -sf $INSTALL_DIR/Godot_v${GODOT_VER}-stable_linux.x86_64 /usr/local/bin/godot
          godot --version

      # 5) Prepare project for import/export
      - name: Prepare Godot workspace
        run: mkdir -p .godot web

      # 6) Import assets (Blender detected automatically)
      - name: Import Godot assets
        run: |
          godot --headless --editor --path . --quit --import

      # 7) Build HTML5 export
      - name: Export HTML5 build
        run: godot --headless --export-release "HTML5" web/index.html

      # 8) Publish to itch.io (main branch only)
      - name: Publish to itch.io
        if: ${{ github.ref == 'refs/heads/main' }}
        env:
          BUTLER_API_KEY: ${{ secrets.ITCHIO_API_KEY }}
        run: |
          curl -L https://broth.itch.ovh/butler/linux-amd64/latest/archive/default \
            -o butler
          chmod +x butler
          ./butler push web "${{ secrets.ITCHIO_GAME }}:html5"
