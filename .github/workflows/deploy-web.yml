name: CI → Web Export & itch.io

on:
  push:
    branches: [main]
  pull_request:

jobs:
  deploy_web:
    runs-on: ubuntu-latest
    container: barichello/godot‑ci:4.4.1‑stable

    steps:
      - name: Checkout game (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Pull Git LFS content
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git lfs pull

      - name: Install dependencies (OpenGL + curl + gpg + jq)
        run: |
          apt-get update
          apt-get install -y \
            curl gnupg software-properties-common jq
          # On Ubuntu‑latest (jammy/kinetic), libgl1-mesa-glx may be replaced by:
          apt-get install -y libgl1          libglx-mesa0

      - name: Add Blender PPA & install Blender ≥ 4.5
        run: |
          curl -fsSL "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x374C7797FB006459" \
            | gpg --dearmor > /usr/share/keyrings/robsavoury.gpg
          echo "deb [signed-by=/usr/share/keyrings/robsavoury.gpg] \
            https://ppa.launchpadcontent.net/savoury1/blender/ubuntu $(lsb_release -cs) main" \
            > /etc/apt/sources.list.d/savoury1-blender.list
          apt-get update
          apt-get install -y blender
          blender --version

      - name: Download latest Godot 4 .4.1‑stable headless binary
        shell: bash
        run: |
          GODOT_TAG="4.4.1‑stable"
          BASE_URL="https://github.com/godotengine/godot/releases/download/${GODOT_TAG}"
          curl -fsSL "$BASE_URL/godot-${GODOT_TAG}.tar.xz" -o godot.tar.xz

      - name: Extract Godot binary safely
        run: |
          # Identify the single root file inside the tar, assumming a single binary file
          BIN=$(tar -tf godot.tar.xz | head -1)
          tar -xJf godot.tar.xz -C /usr/local/bin "$BIN"
          chmod +x "/usr/local/bin/$BIN"
          mv "/usr/local/bin/$BIN" /usr/local/bin/godot

      - name: Check Godot
        run: god
